name: 每日更新比特幣前100大錢包狀態
on:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 00:00（台灣早上 08:00）
  workflow_dispatch: # 支援手動觸發
jobs:
  update-wallet:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 檢查儲存庫
        uses: actions/checkout@v4
      - name: Pull 遠端變更  # 新增這個步驟
        run: git pull origin main --rebase  # 使用 --rebase 避免 merge commit；如果衝突嚴重，可改成 git pull --merge
      - name: 安裝 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: 安裝依賴套件
        run: |
          python -m pip install --upgrade pip
          # 移除 cloudscraper，使用 requests 進行 Scrapingant API 呼叫
          pip install requests beautifulsoup4 openai
          
      # 新增：設定 Scrapingant API Key
      # 請在您的 GitHub Repository Secrets 中設定名為 SCRAPINGANT_API_KEY 的 Secret
      - name: 設定 Scrapingant API 金鑰
        run: echo "SCRAPINGANT_API_KEY=${{ secrets.SCRAPINGANT_API_KEY }}" >> $GITHUB_ENV
        
      # 原有的 xAI API 金鑰設定，可保留或移除
      - name: 設定 xAI API 金鑰
        run: echo "XAI_API_KEY_BITCOIN=${{ secrets.XAI_API_KEY_BITCOIN }}" >> $GITHUB_ENV
        
      - name: 執行更新腳本
        run: python update_wallet.py
        
      - name: 檢查 wallet.json 是否存在
        run: |
          if [ ! -f wallet.json ]; then
            echo "錯誤：wallet.json 未生成"
            exit 1
          fi

      - name: 提交更新後的檔案
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 檢查是否有變動
          if git diff --exit-code --quiet wallet.json; then
            echo "wallet.json 沒有變動，跳過提交。"
          else
            echo "偵測到 wallet.json 變動，提交檔案。"
            git add wallet.json
            git commit -m "chore: :robot: Daily update Bitcoin Top 100 wallets status"
            git push
          fi
